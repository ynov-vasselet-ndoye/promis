name: Build and push docker images

on:
    workflow_dispatch:
    release:
        types: [published]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: üõú Checkout
              uses: actions/checkout@v4

            - name: üñºÔ∏è Build and push the frontend image
              if: ${{contains(github.event.release.tag_name, 'front')}}
              run: |
                docker login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} ghcr.io
                docker build ./frontend/Dockerfile.production --tag ghcr.io/${{ github.repository }}-front:latest
                docker push ghcr.io/${{ github.repository }}-front:latest

            - name: üóÉÔ∏è Build and push the backend image
              if: ${{contains(github.event.release.tag_name, 'back')}}
              run: |
                docker login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} ghcr.io
                docker build ./backend --tag ghcr.io/${{ github.repository }}-back:latest
                docker push ghcr.io/${{ github.repository }}-back:latest
            - name: executing remote ssh commands using password
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USERNAME }}
                  password: ${{ secrets.SSH_PASSWORD }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      cd studies/ynov/promis
                      docker compose up -d --build --pull always
